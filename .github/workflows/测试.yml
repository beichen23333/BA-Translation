name: Blue Archive DB Bruteforce

on:
  workflow_dispatch:
    inputs:
      max_length:
        description: 'Maximum key length to test'
        required: false
        default: '8'
      charset_type:
        description: 'Character set type'
        required: false
        default: 'alphanum'
        type: choice
        options:
        - alphanum
        - simple
        - full
      excluded_keys:
        description: 'Excluded keys file (base64 encoded)'
        required: false
        default: ''
      iteration:
        description: 'Iteration number (auto-increment)'
        required: false
        default: '1'

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      timestamp: ${{ steps.timestamp.outputs.time }}
      run_id: ${{ steps.run_id.outputs.id }}
      iteration: ${{ steps.iteration.outputs.num }}
    steps:
      - uses: actions/checkout@v4
      - name: Clone repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git
      - name: Move contents to current directory
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack
      - name: Download ExcelDB.db
        run: |
          wget -q https://prod-clientpatch.bluearchiveyostar.com/r86_vm4arsjw95mxfrp4m01q_2/TableBundles/ExcelDB.db -O ExcelDB.db
      - name: Create directories
        run: |
          mkdir -p progress excluded_keys
      - name: Decode excluded keys if provided
        if: ${{ github.event.inputs.excluded_keys != '' }}
        run: |
          echo "${{ github.event.inputs.excluded_keys }}" | base64 -d > excluded_keys/previous.txt
          echo "Loaded $(wc -l < excluded_keys/previous.txt) excluded keys"
      - name: Generate IDs
        id: timestamp
        run: |
          echo "time=$(date +%s)" >> $GITHUB_OUTPUT
          echo "id=run-${{ github.run_id }}-$(date +%s)" >> $GITHUB_OUTPUT
          echo "num=${{ github.event.inputs.iteration }}" >> $GITHUB_OUTPUT
      - name: Upload workspace
        uses: actions/upload-artifact@v4
        with:
          name: workspace-${{ steps.timestamp.outputs.id }}
          path: |
            .
          retention-days: 7

  bruteforce:
    needs: setup
    runs-on: ubuntu-latest
    timeout-minutes: 300  # 5å°æ—¶è¶…æ—¶
    strategy:
      matrix:
        worker: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19]
    steps:
      - name: Download workspace
        uses: actions/download-artifact@v4
        with:
          name: workspace-${{ needs.setup.outputs.run_id }}
          path: ./
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install xxhash pycryptodome
      - name: Run bruteforce with timeout handling
        run: |
          # è®¾ç½®5å°æ—¶è¶…æ—¶ï¼ˆ295åˆ†é’Ÿï¼Œç•™5åˆ†é’Ÿä¿å­˜ï¼‰
          timeout 295m python bruteforce_restartable.py \
            --worker ${{ matrix.worker }} \
            --max-length ${{ github.event.inputs.max_length }} \
            --charset ${{ github.event.inputs.charset_type }} \
            --run-id ${{ needs.setup.outputs.run_id }} \
            --iteration ${{ needs.setup.outputs.iteration }} || \
          (echo "Worker ${{ matrix.worker }} timed out" && exit 124)
        continue-on-error: true
        id: bruteforce
      - name: Save timeout results
        if: steps.bruteforce.outcome == 'failure' || steps.bruteforce.outcome == 'cancelled'
        run: |
          echo "Saving timeout state for worker ${{ matrix.worker }}"
          # ç¡®ä¿è¿›åº¦æ–‡ä»¶å­˜åœ¨
          touch progress/timeout_${{ matrix.worker }}.txt
          echo "Timeout at $(date)" > progress/timeout_${{ matrix.worker }}.txt
      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ needs.setup.outputs.run_id }}-worker-${{ matrix.worker }}
          path: |
            key_*.txt
            worker_${{ matrix.worker }}.log
            progress/
            excluded_keys/
          retention-days: 7

  analyze-and-restart:
    needs: [setup, bruteforce]
    runs-on: ubuntu-latest
    if: always()
    outputs:
      should_restart: ${{ steps.analyze.outputs.restart }}
      excluded_keys_b64: ${{ steps.analyze.outputs.excluded_b64 }}
      next_iteration: ${{ steps.analyze.outputs.next_iteration }}
    steps:
      - name: Download all results
        uses: actions/download-artifact@v4
        with:
          path: results
          pattern: results-${{ needs.setup.outputs.run_id }}-*
          merge-multiple: true
      - name: Analyze results and prepare restart
        id: analyze
        run: |
          echo "=== Analysis Results ==="
          
          # æ£€æŸ¥æ˜¯å¦æ‰¾åˆ°å¯†é’¥
          if find results -name "key_*.txt" | grep -q .; then
            echo "ðŸŽ‰ KEY FOUND - STOPPING WORKFLOW"
            find results -name "key_*.txt" -exec echo "Key: {}" \; -exec cat {} \;
            echo "::warning::ðŸ”‘ Valid key found! Workflow completed."
            echo "restart=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # æ£€æŸ¥è¶…æ—¶çš„worker
          timeout_workers=()
          for i in {0..19}; do
            if [ -f "results/progress/timeout_$i.txt" ]; then
              timeout_workers+=($i)
              echo "Worker $i: TIMEOUT"
            elif [ -f "results/key_$i.txt" ]; then
              echo "Worker $i: COMPLETED (no key)"
            elif [ -f "results/worker_$i.log" ]; then
              echo "Worker $i: COMPLETED (no key)"
            else
              echo "Worker $i: UNKNOWN STATUS"
            fi
          done
          
          # æ”¶é›†æ‰€æœ‰æµ‹è¯•è¿‡çš„é”™è¯¯å¯†é’¥
          echo "Collecting tested keys from logs..."
          python3 << 'EOF'
          import os
          import re
          
          tested_keys = set()
          
          # ä»Žæ—¥å¿—æ–‡ä»¶ä¸­æå–æµ‹è¯•è¿‡çš„å¯†é’¥
          for i in range(20):
              log_file = f"results/worker_{i}.log"
              if os.path.exists(log_file):
                  with open(log_file, 'r', errors='ignore') as f:
                      content = f.read()
                  # æå–ç±»ä¼¼ "Testing key: abc123" çš„æ¨¡å¼
                  keys = re.findall(r'Testing key: ([^\s]+)', content)
                  tested_keys.update(keys)
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          with open('tested_keys.txt', 'w') as f:
              for key in tested_keys:
                  f.write(key + '\n')
          
          print(f"Collected {len(tested_keys)} tested keys")
          EOF
          
          # ç¼–ç ä¸ºbase64ç”¨äºŽä¸‹ä¸€æ¬¡è¿è¡Œ
          if [ -f "tested_keys.txt" ] && [ -s "tested_keys.txt" ]; then
            base64_encoded=$(base64 -w 0 tested_keys.txt)
            echo "excluded_b64=$base64_encoded" >> $GITHUB_OUTPUT
            echo "Collected $(wc -l < tested_keys.txt) keys to exclude"
          else
            # å¦‚æžœæ²¡æœ‰æ–°å¯†é’¥ï¼Œä½¿ç”¨ä¼ å…¥çš„excluded_keys
            if [ -f "results/excluded_keys/previous.txt" ]; then
              base64_encoded=$(base64 -w 0 results/excluded_keys/previous.txt)
              echo "excluded_b64=$base64_encoded" >> $GITHUB_OUTPUT
            else
              echo "excluded_b64=" >> $GITHUB_OUTPUT
            fi
          fi
          
          # å†³å®šæ˜¯å¦é‡å¯
          if [ ${#timeout_workers[@]} -gt 0 ]; then
            echo "RESTARTING: ${#timeout_workers[@]} workers timed out"
            echo "restart=true" >> $GITHUB_OUTPUT
            next_iteration=$(( ${{ needs.setup.outputs.iteration }} + 1 ))
            echo "next_iteration=$next_iteration" >> $GITHUB_OUTPUT
          else
            echo "NO RESTART: All workers completed"
            echo "restart=false" >> $GITHUB_OUTPUT
          fi
      - name: Restart workflow if needed
        if: steps.analyze.outputs.restart == 'true'
        uses: actions/github-script@v6
        with:
          script: |
            const { excluded_b64, next_iteration } = process.env;
            
            // ç­‰å¾…ä¸€æ®µæ—¶é—´ç¡®ä¿æ‰€æœ‰artifactä¸Šä¼ å®Œæˆ
            await new Promise(resolve => setTimeout(resolve, 30000));
            
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: context.workflow,
              ref: context.ref,
              inputs: {
                max_length: '${{ github.event.inputs.max_length }}',
                charset_type: '${{ github.event.inputs.charset_type }}',
                excluded_keys: excluded_b64,
                iteration: next_iteration
              }
            });
            
            console.log(`Restarted workflow (iteration ${next_iteration})`);
            console.log(`Excluded keys: ${excluded_b64 ? excluded_b64.length + ' chars' : 'none'}`);
        env:
          excluded_b64: ${{ steps.analyze.outputs.excluded_keys_b64 }}
          next_iteration: ${{ steps.analyze.outputs.next_iteration }}
