name: BlueArchive APK Hook

on: 
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  hook-bluearchive:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          android-tools-adb \
          wget \
          unzip \
          openjdk-11-jdk \
          python3 \
          python3-pip \
          docker.io

    - name: Start Docker service
      run: |
        sudo systemctl start docker
        sudo docker --version

    - name: Start Redroid emulator
      run: |
        echo "启动Redroid容器..."
        sudo docker run -d \
          --privileged \
          -v ~/data11:/data \
          -p 5555:5555 \
          --name redroid \
          redroid/redroid:11.0.0-latest \
          androidboot.hardware=redroid \
          androidboot.selinux=permissive
        
        echo "等待容器启动..."
        sleep 30
        
        echo "检查容器状态..."
        sudo docker ps -a
        
        echo "尝试连接ADB..."
        adb disconnect
        adb kill-server
        adb start-server
        adb connect localhost:5555
        
        echo "等待设备上线..."
        timeout 30 bash -c 'while [[ "$(adb devices | grep -c "device$")" -eq 0 ]]; do sleep 2; adb connect localhost:5555; done'
        
        echo "设备状态:"
        adb devices
        adb wait-for-device
        
    - name: Install APK
      run: |
        echo "安装APK..."
        if [ -f "bluearchive_repacked.apk" ]; then
          adb install bluearchive_repacked.apk
        else
          find Temp -name "*.apk" -exec adb install {} \;
        fi
        
        echo "已安装包:"
        adb shell pm list packages | grep -i bluearchive
        
    - name: Setup Frida
      run: |
        echo "设置Frida..."
        wget -q https://github.com/frida/frida/releases/download/16.1.8/frida-server-16.1.8-android-arm64.xz
        unxz frida-server-16.1.8-android-arm64.xz
        adb push frida-server-16.1.8-android-arm64 /data/local/tmp/frida-server
        adb shell "chmod 755 /data/local/tmp/frida-server"
        adb shell "nohup /data/local/tmp/frida-server > /dev/null 2>&1 &"
        sleep 10
        
        pip3 install frida-tools
        
    - name: Run hook
      run: |
        cat > hook.js << 'EOF'
        Java.perform(function() {
            console.log("[+] Hook脚本启动");
            
            setTimeout(function() {
                try {
                    var targetClass = Java.use("MX.NetworkProtocol.QueuingGetCryptoKeysResponse");
                    console.log("[+] 找到目标类");
                    
                    targetClass.set_EncryptedSqlCipherLicense.implementation = function(value) {
                        console.log("[HOOK] EncryptedSqlCipherLicense: " + value);
                        var file = new File("/sdcard/license.txt", "w");
                        file.write(value);
                        file.close();
                        return this.set_EncryptedSqlCipherLicense(value);
                    };
                    
                    targetClass.set_EncryptedSqlCipherKey.implementation = function(value) {
                        console.log("[HOOK] EncryptedSqlCipherKey: " + value);
                        var file = new File("/sdcard/key.txt", "w");
                        file.write(value);
                        file.close();
                        return this.set_EncryptedSqlCipherKey(value);
                    };
                    
                } catch(e) { console.log("Error: " + e); }
            }, 5000);
        });
        EOF
        
        adb shell am start -n com.yostarjp.bluearchive/com.yostarjp.bluearchive.MxUnityPlayerActivity
        sleep 30
        timeout 300 frida -U -l hook.js -f com.yostarjp.bluearchive --no-pause || echo "完成"
        
    - name: Collect results
      run: |
        adb pull /sdcard/license.txt ./ || echo "无license"
        adb pull /sdcard/key.txt ./ || echo "无key"
        
        echo "=== 结果 ==="
        [ -f "license.txt" ] && cat license.txt || echo "无license数据"
        [ -f "key.txt" ] && cat key.txt || echo "无key数据"
        
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bluearchive-results
        path: |
          license.txt
          key.txt
        retention-days: 7
