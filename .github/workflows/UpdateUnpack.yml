name: Unpack-Update Table

on:
  workflow_dispatch:
    inputs:
      jp_server:
        description: 'Enable JP server'
        required: false
        type: boolean
        default: false
      gl_server:
        description: 'Enable GL server'
        required: false
        type: boolean
        default: false
      cn_server:
        description: 'Enable CN server'
        required: false
        type: boolean
        default: false
      db_key:
        description: 'Database decryption key (for JP server)'
        required: false
        type: string
        default: ''
  repository_dispatch:
    types: [run-deployment]
  schedule:
    - cron: '0 */1 * * *'

permissions:
  contents: write

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-outputs.outputs.matrix }}
      versions: ${{ steps.set-outputs.outputs.versions }}
      flatdata-versions: ${{ steps.set-outputs.outputs.flatdata-versions }}
      run-flags: ${{ steps.set-outputs.outputs.run-flags }}
      setup-flatdata-flags: ${{ steps.set-outputs.outputs.setup-flatdata-flags }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Checkout BA-Unpack repository
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python environment
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Determine servers
        id: determine-servers
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # 处理单选开关输入
            SERVERS=()
            if [ "${{ inputs.jp_server }}" = "true" ]; then
              SERVERS+=("JP")
            fi
            if [ "${{ inputs.gl_server }}" = "true" ]; then
              SERVERS+=("GL")
            fi
            if [ "${{ inputs.cn_server }}" = "true" ]; then
              SERVERS+=("CN")
            fi
            
            # 如果没有选择任何服务器，默认使用 JP
            if [ ${#SERVERS[@]} -eq 0 ]; then
              SERVERS=("JP")
            fi
            
            SERVERS_RAW=$(printf '%s\n' "${SERVERS[@]}" | jq -R . | jq -s .)
          elif [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            SERVERS_RAW='${{ toJSON(github.event.client_payload.servers) || '["JP"]' }}'
          else
            SERVERS_RAW='["JP"]'
          fi
          echo "SERVERS_RAW=$SERVERS_RAW" >> $GITHUB_OUTPUT
          echo "Selected servers: $SERVERS_RAW"

      - name: Get version information
        id: get-versions
        run: |
          SERVERS_RAW='${{ steps.determine-servers.outputs.SERVERS_RAW }}'
          echo "SERVERS_RAW value: $SERVERS_RAW"
          
          # 使用 jq 安全地解析数组
          SERVERS=$(echo "$SERVERS_RAW" | jq -r '.[]' 2>/dev/null || echo "JP")
          
          VERSIONS="{}"
          FLATDATA_VERSIONS="{}"
          
          # 处理单个或多个服务器
          if echo "$SERVERS" | grep -q " "; then
            # 多个服务器
            while IFS= read -r SERVER; do
              if [ -n "$SERVER" ]; then
                VERSION=$(bash version.sh "$SERVER" info.json 2>/dev/null | grep BA_VERSION_NAME | cut -d= -f2 || echo "")
                FLATDATA_VERSION=$(bash version.sh "$SERVER" info.json 2>/dev/null | grep FLATDATA_VERSION_NAME | cut -d= -f2 || echo "")
                
                if [ -n "$VERSION" ]; then
                  VERSIONS=$(echo "$VERSIONS" | jq --arg server "$SERVER" --arg version "$VERSION" '. + {($server): $version}')
                fi
                if [ -n "$FLATDATA_VERSION" ]; then
                  FLATDATA_VERSIONS=$(echo "$FLATDATA_VERSIONS" | jq --arg server "$SERVER" --arg version "$FLATDATA_VERSION" '. + {($server): $version}')
                fi
              fi
            done <<< "$SERVERS"
          else
            # 单个服务器
            SERVER="$SERVERS"
            VERSION=$(bash version.sh "$SERVER" info.json 2>/dev/null | grep BA_VERSION_NAME | cut -d= -f2 || echo "")
            FLATDATA_VERSION=$(bash version.sh "$SERVER" info.json 2>/dev/null | grep FLATDATA_VERSION_NAME | cut -d= -f2 || echo "")
            
            if [ -n "$VERSION" ]; then
              VERSIONS=$(echo "$VERSIONS" | jq --arg server "$SERVER" --arg version "$VERSION" '. + {($server): $version}')
            fi
            if [ -n "$FLATDATA_VERSION" ]; then
              FLATDATA_VERSIONS=$(echo "$FLATDATA_VERSIONS" | jq --arg server "$SERVER" --arg version "$FLATDATA_VERSION" '. + {($server): $version}')
            fi
          fi
          
          echo "VERSIONS=$VERSIONS" >> $GITHUB_OUTPUT
          echo "FLATDATA_VERSIONS=$FLATDATA_VERSIONS" >> $GITHUB_OUTPUT
          echo "Versions: $VERSIONS"
          echo "FlatData versions: $FLATDATA_VERSIONS"

      - name: Check existing files
        id: check-files
        run: |
          SERVERS_RAW='${{ steps.determine-servers.outputs.SERVERS_RAW }}'
          echo "SERVERS_RAW: $SERVERS_RAW"
          
          SERVERS=$(echo "$SERVERS_RAW" | jq -r '.[]' 2>/dev/null || echo "JP")
          echo "Servers: $SERVERS"
          
          VERSIONS='${{ steps.get-versions.outputs.VERSIONS }}'
          FLATDATA_VERSIONS='${{ steps.get-versions.outputs.FLATDATA_VERSIONS }}'
          
          RUN_FLAGS="{}"
          SETUP_FLATDATA_FLAGS="{}"
          
          # 处理单个或多个服务器
          if echo "$SERVERS" | grep -q " "; then
            while IFS= read -r SERVER; do
              if [ -n "$SERVER" ]; then
                process_server "$SERVER"
              fi
            done <<< "$SERVERS"
          else
            process_server "$SERVERS"
          fi
          
          echo "RUN_FLAGS=$RUN_FLAGS" >> $GITHUB_OUTPUT
          echo "SETUP_FLATDATA_FLAGS=$SETUP_FLATDATA_FLAGS" >> $GITHUB_OUTPUT
          
        env:
          RUN_FLAGS: ${{ steps.get-versions.outputs.RUN_FLAGS }}
          SETUP_FLATDATA_FLAGS: ${{ steps.get-versions.outputs.SETUP_FLATDATA_FLAGS }}

      - name: Set final outputs
        id: set-outputs
        run: |
          MATRIX='${{ steps.determine-servers.outputs.SERVERS_RAW }}'
          # 验证 MATRIX 是有效的 JSON 数组
          if ! echo "$MATRIX" | jq -e . >/dev/null 2>&1; then
            echo "Invalid MATRIX format, defaulting to [\"JP\"]"
            MATRIX='["JP"]'
          fi
          
          echo "matrix=$MATRIX" >> $GITHUB_OUTPUT
          echo "versions=${{ steps.get-versions.outputs.VERSIONS }}" >> $GITHUB_OUTPUT
          echo "flatdata-versions=${{ steps.get-versions.outputs.FLATDATA_VERSIONS }}" >> $GITHUB_OUTPUT
          echo "run-flags=${{ steps.check-files.outputs.RUN_FLAGS }}" >> $GITHUB_OUTPUT
          echo "setup-flatdata-flags=${{ steps.check-files.outputs.SETUP_FLATDATA_FLAGS }}" >> $GITHUB_OUTPUT

  Table:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        server: ${{ fromJSON(needs.setup.outputs.matrix) }}
    env:
      SERVER: ${{ matrix.server }}
      BA_VERSION_NAME: ${{ fromJSON(needs.setup.outputs.versions)[matrix.server] }}
      FLATDATA_VERSION_NAME: ${{ fromJSON(needs.setup.outputs.flatdata-versions)[matrix.server] }}
    steps:
      - name: Check if should run
        id: check-run
        run: |
          if [ "${{ github.event_name }}" == 'schedule' ]; then
            RUN_FLAGS='${{ needs.setup.outputs.run-flags }}'
            SERVER_RUN_FLAG=$(echo "$RUN_FLAGS" | jq -r --arg server "${{ matrix.server }}" '.[$server]')
            if [ "$SERVER_RUN_FLAG" == 'true' ]; then
              echo "Should run for server ${{ matrix.server }}"
              echo "should-run=true" >> $GITHUB_OUTPUT
            else
              echo "Skipping server ${{ matrix.server }} for schedule run"
              echo "should-run=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "Should run for manual/dispatch event"
            echo "should-run=true" >> $GITHUB_OUTPUT
          fi

      - name: Skip if not needed
        if: steps.check-run.outputs.should-run == 'false'
        run: |
          echo "Skipping execution for server ${{ matrix.server }}"
          exit 0

      - name: Checkout code
        if: steps.check-run.outputs.should-run == 'true'
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repository
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com:/beichen23333/BA-Unpack.git

      - name: Move contents to current directory
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          mv BA-Unpack/* .
          rm -rf BA-Unpack

      - name: Set up Python 3.13
        if: steps.check-run.outputs.should-run == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.13'

      - name: Install requirements
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Login
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Clone BA-FlatData
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git

      - name: Check for existing FlatData zip
        if: steps.check-run.outputs.should-run == 'true'
        id: check-flatdata-zip
        run: |
          if [ -f "BA-FlatData/${SERVER}${BA_VERSION_NAME}.zip" ]; then
            echo "Using existing FlatData zip file"
            echo "zip-exists=true" >> $GITHUB_OUTPUT
          else
            echo "FlatData zip file not found, will generate new one"
            echo "zip-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup FlatData conditionally
        if: steps.check-run.outputs.should-run == 'true' && fromJSON(needs.setup.outputs.setup-flatdata-flags)[matrix.server] == 'false' && steps.check-flatdata-zip.outputs.zip-exists == 'false'
        run: |
          if [ "$SERVER" = "CN" ]; then
            git clone --depth 1 --branch "CN" https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git flatdata-cn
            if [ -f "flatdata-cn/dump.cs" ]; then
              mkdir -p Dumps
              cp flatdata-cn/dump.cs Dumps/
              echo "Copied dump.cs from CN branch to Dumps directory"
            fi
            rm -rf flatdata-cn
          fi
          python setup_flatdata.py $SERVER

      - name: Downloads Table files and run MemoryPackRepacker
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          chmod +x update/update_table.sh
          ./update/update_table.sh $SERVER

      - name: Create temporary directory for unpacked files
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          mkdir -p temp_unpacked

      - name: Decrypt database for JP server
        if: steps.check-run.outputs.should-run == 'true' && matrix.server == 'JP'
        run: |
          DB_FILE="./downloads/TableBundles/ExcelDB.db"
          if [ -f "$DB_FILE" ]; then
            # 修复：安全地处理 db_key
            if [ -n "${{ inputs.db_key }}" ] && [ "${{ inputs.db_key }}" != "" ]; then
              KEY="${{ inputs.db_key }}"
            else
              KEY="${{ secrets.DB_DECRYPT_KEY }}"
            fi
            
            if [ -z "$KEY" ]; then
              echo "Warning: No decryption key provided, skipping database decryption"
              exit 0
            fi
            
            echo "PRAGMA key = \"x'$KEY'\";" > decrypt_commands.txt
            echo "BEGIN TRANSACTION;" >> decrypt_commands.txt
            echo "SELECT sqlcipher_export('main');" >> decrypt_commands.txt
            echo "COMMIT;" >> decrypt_commands.txt
            echo ".quit" >> decrypt_commands.txt
            
            sqlcipher "$DB_FILE" < decrypt_commands.txt
            echo "Database decrypted successfully"
          else
            echo "Database file not found: $DB_FILE"
          fi

      - name: Unpack ExcelDB.db and Excel.zip to temporary directory
        if: steps.check-run.outputs.should-run == 'true'
        run: |
          python unpack_excel.py ./downloads/TableBundles/ExcelDB.db ./downloads/TableBundles/Excel.zip ./unpacked ./temp_unpacked/FlatData config.json temp_text $SERVER

      - name: Prepare FlatData zip conditionally
        if: steps.check-run.outputs.should-run == 'true' && fromJSON(needs.setup.outputs.setup-flatdata-flags)[matrix.server] == 'false' && steps.check-flatdata-zip.outputs.zip-exists == 'false'
        run: |
          mkdir -p temp_flatdata_output
          cd ./temp_unpacked/FlatData/
          zip -j "../../temp_flatdata_output/${SERVER}${BA_VERSION_NAME}.zip" *
          cd

      - name: Check for existing Text zip
        if: steps.check-run.outputs.should-run == 'true'
        id: check-text-zip
        run: |
          if [ -f "${SERVER}${BA_VERSION_NAME}.zip" ]; then
            echo "Using existing Text zip file"
            echo "text-zip-exists=true" >> $GITHUB_OUTPUT
          else
            echo "Text zip file not found, will generate new one"
            echo "text-zip-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Text zip conditionally
        if: steps.check-run.outputs.should-run == 'true' && steps.check-text-zip.outputs.text-zip-exists == 'false'
        run: |
          mkdir -p temp_text_output
          
          if [ -d "temp_unpacked/FlatData/ExcelTable" ]; then
            cp -r temp_unpacked/FlatData/ExcelTable temp_text_output/
          fi
          
          cd temp_text_output
          zip -r "../temp_flatdata_output/${SERVER}${BA_VERSION_NAME}.zip" *
          cd

      - name: Check for existing Catalog zip
        if: steps.check-run.outputs.should-run == 'true'
        id: check-catalog-zip
        run: |
          if [ -f "${SERVER}Catalog${BA_VERSION_NAME}.zip" ]; then
            echo "Using existing Catalog zip file"
            echo "catalog-zip-exists=true" >> $GITHUB_OUTPUT
          else
            echo "Catalog zip file not found, will generate new one"
            echo "catalog-zip-exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Prepare Catalog zip conditionally
        if: steps.check-run.outputs.should-run == 'true' && steps.check-catalog-zip.outputs.catalog-zip-exists == 'false'
        run: |
          if [ -f "TableCatalog.json" ] && [ -f "MediaCatalog.json" ] && [ -f "BundlePackingInfo-iOS.json" ] && [ -f "BundlePackingInfo-Android.json" ]; then
            mkdir -p temp_flatdata_output
            zip "temp_flatdata_output/${SERVER}Catalog${BA_VERSION_NAME}.zip" TableCatalog.json MediaCatalog.json BundlePackingInfo-iOS.json BundlePackingInfo-Android.json
          fi

      - name: Upload Table artifacts
        if: steps.check-run.outputs.should-run == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: table-changes-${{ matrix.server }}
          path: |
            temp_flatdata_output/
          retention-days: 1
        continue-on-error: true

  Commit:
    runs-on: ubuntu-latest
    needs: [setup, Table]
    if: always() && (contains(needs.*.result, 'success') || contains(needs.*.result, 'skipped')) && (github.event_name == 'workflow_dispatch' || github.event_name == 'repository_dispatch' || (github.event_name == 'schedule' && fromJSON(needs.setup.outputs.run-flags)[fromJSON(needs.setup.outputs.matrix)[0]] == 'true'))
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: false

      - name: Clone repositories
        run: |
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-Text.git
          git clone --depth 1 https://x-access-token:${{ secrets.APK_SRC_REPO }}@github.com/beichen23333/BA-FlatData.git

      - name: Download all artifacts
        uses: actions/github-script@v7
        with:
          script: |
            const servers = ${{ needs.setup.outputs.matrix }};
            const runFlags = ${{ needs.setup.outputs.run-flags }};
            
            for (const server of servers) {
              // 检查计划任务是否需要运行
              if (process.env.GITHUB_EVENT_NAME === 'schedule') {
                const shouldRun = runFlags[server];
                if (!shouldRun) {
                  console.log(`Skipping ${server} for schedule run`);
                  continue;
                }
              }
              
              try {
                // 下载制品
                const result = await github.rest.actions.downloadArtifact({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  artifact_name: `table-changes-${server}`,
                  archive_format: 'zip'
                });
                console.log(`Downloaded artifacts for ${server}`);
              } catch (error) {
                console.log(`No artifacts found for ${server}`);
              }
            }

      - name: Process and merge artifacts
        run: |
          SERVERS_RAW='${{ needs.setup.outputs.matrix }}'
          echo "Raw servers: $SERVERS_RAW"
          
          # 安全地解析服务器数组
          SERVERS=$(echo "$SERVERS_RAW" | jq -r '.[]' 2>/dev/null || echo "JP")
          echo "Parsed servers: $SERVERS"
          
          VERSIONS='${{ needs.setup.outputs.versions }}'
          FLATDATA_VERSIONS='${{ needs.setup.outputs.flatdata-versions }}'
          SETUP_FLATDATA_FLAGS='${{ needs.setup.outputs.setup-flatdata-flags }}'
          
          FLATDATA_HAS_CHANGES=false
          TEXT_HAS_CHANGES=false
          
          # 处理服务器数组
          if echo "$SERVERS" | grep -q " "; then
            while IFS= read -r SERVER; do
              if [ -n "$SERVER" ]; then
                process_server_artifacts "$SERVER"
              fi
            done <<< "$SERVERS"
          else
            process_server_artifacts "$SERVERS"
          fi
          
          echo "FLATDATA_HAS_CHANGES=$FLATDATA_HAS_CHANGES" >> $GITHUB_ENV
          echo "TEXT_HAS_CHANGES=$TEXT_HAS_CHANGES" >> $GITHUB_ENV

      - name: Configure git
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "GitHub Actions"

      - name: Commit to BA-Text
        if: env.TEXT_HAS_CHANGES == 'true'
        run: |
          cd BA-Text
          SERVERS_RAW='${{ needs.setup.outputs.matrix }}'
          SERVERS=$(echo "$SERVERS_RAW" | jq -r '.[]' 2>/dev/null || echo "JP")
          VERSIONS='${{ needs.setup.outputs.versions }}'
          
          # 处理提交
          if echo "$SERVERS" | grep -q " "; then
            while IFS= read -r SERVER; do
              if [ -n "$SERVER" ]; then
                commit_to_branch "$SERVER"
              fi
            done <<< "$SERVERS"
          else
            commit_to_branch "$SERVERS"
          fi
          cd ..

      - name: Commit to BA-FlatData
        if: env.FLATDATA_HAS_CHANGES == 'true'
        run: |
          cd BA-FlatData
          SERVERS_RAW='${{ needs.setup.outputs.matrix }}'
          SERVERS=$(echo "$SERVERS_RAW" | jq -r '.[]' 2>/dev/null || echo "JP")
          VERSIONS='${{ needs.setup.outputs.versions }}'
          SETUP_FLATDATA_FLAGS='${{ needs.setup.outputs.setup-flatdata-flags }}'
          
          # 处理提交
          if echo "$SERVERS" | grep -q " "; then
            while IFS= read -r SERVER; do
              if [ -n "$SERVER" ]; then
                commit_to_branch "$SERVER"
              fi
            done <<< "$SERVERS"
          else
            commit_to_branch "$SERVERS"
          fi
          cd ..

      - name: Cleanup
        run: |
          rm -rf artifacts
